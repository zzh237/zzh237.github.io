---
layout: post
title: 
category: cuda
tags: [cuda]
modified: 8-15-2023
comments: false
---

## Solve divergence
### Example, perform different operations on different columns
Warp Execution
--------------

All threads of a warp are executed by the SIMD hardware as a bundle, where the same instruction is run for all threads.

Warp is the unit of thread scheduling in SMs.

### when is it good?

When all threads within a warp follow the same control flow.

For example, for an if-else construct, the execution works well when either all threads execute the if part or all execute the else part.

### when is it bad?

When threads within a warp take different control flow paths, the SIMD hardware will take *multiple passes* through these divergent paths. During each pass, the threads that follow the other path are not allowed to take effect.

These passes are *sequential* to each other, thus they will add to the execution time.

```cpp
__global__ void matrixOperationRowWise(float* g_data, int width) {
    // Cast the pointer to float2*
    float2* g_data2 = (float2*)g_data;

    // Calculate row and column for float2 elements
    int row = blockIdx.y * blockDim.y + threadIdx.y; // blockIdx.y = {0,...,1023}, blockDim.y = 1
    int col = blockIdx.x * blockDim.x + threadIdx.x; // blockIdx.x = {0,1}, blockDim.x = 256

    // Calculate linear index for float2 elements
    int idx = row * (width / 2) + col; // width divides 2 due to g_data2 is array-like

    // Ensure we don't go out of bounds
    if (row < width && col < width / 2) {
        float2 val = g_data2[idx]; // row-wise saved matrix

        // Perform operations on each component of float2
        val.x = (2 * col % 2 == 0) ? evenOperation(val.x) : oddOperation(val.x); // Even or Odd column
        val.y = (2 * col % 2 == 0) ? oddOperation(val.y) : evenOperation(val.y); // Odd or Even column

        // Write back results
        g_data2[idx] = val;
    }
}

// Usage: matrixOperationRowWise<<<dim3(2, 1024), dim3(256, 1)>>>(g_data, 1024); // The matrix is 1024 * 1024, and the girdDim.y = 1024, 
// gridDim.x = 2, 

```